

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>jaws_libp.references.avro &mdash; jlab-jaws 4.3.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<link href="../../../_static/rtd_custom.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> jlab-jaws
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/jaws_libp.html">jaws_libp</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">jlab-jaws</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>jaws_libp.references.avro</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for jaws_libp.references.avro</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#</span>
<span class="c1"># Copyright 2020 Confluent Inc.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1">#</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">loads</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span><span class="p">,</span> <span class="n">unpack</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">overload</span>

<span class="kn">from</span> <span class="nn">confluent_kafka.schema_registry.avro</span> <span class="kn">import</span> <span class="n">AvroSerializer</span><span class="p">,</span> <span class="n">AvroDeserializer</span>
<span class="kn">from</span> <span class="nn">fastavro</span> <span class="kn">import</span> <span class="p">(</span><span class="n">parse_schema</span><span class="p">,</span>
                      <span class="n">schemaless_reader</span><span class="p">,</span>
                      <span class="n">schemaless_writer</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">confluent_kafka.schema_registry</span> <span class="kn">import</span> <span class="p">(</span><span class="n">_MAGIC_BYTE</span><span class="p">,</span>
               <span class="n">Schema</span><span class="p">,</span>
               <span class="n">topic_subject_name_strategy</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">confluent_kafka.serialization</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Deserializer</span><span class="p">,</span>
                                           <span class="n">SerializationError</span><span class="p">,</span>
                                           <span class="n">Serializer</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_ContextStringIO</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper to allow use of StringIO via &#39;with&#39; constructs.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">_schema_loads</span><span class="p">(</span><span class="n">schema_str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Instantiates a Schema instance from a declaration string</span>

<span class="sd">    Args:</span>
<span class="sd">        schema_str (str): Avro Schema declaration.</span>

<span class="sd">    .. _Schema declaration:</span>
<span class="sd">        https://avro.apache.org/docs/current/spec.html#schemas</span>

<span class="sd">    Returns:</span>
<span class="sd">        Schema: Schema instance</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">schema_str</span> <span class="o">=</span> <span class="n">schema_str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="c1"># canonical form primitive declarations are not supported</span>
    <span class="k">if</span> <span class="n">schema_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;{&quot;</span> <span class="ow">and</span> <span class="n">schema_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;[&quot;</span><span class="p">:</span>
        <span class="n">schema_str</span> <span class="o">=</span> <span class="s1">&#39;{&quot;type&quot;:&#39;</span> <span class="o">+</span> <span class="n">schema_str</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span>

    <span class="k">return</span> <span class="n">Schema</span><span class="p">(</span><span class="n">schema_str</span><span class="p">,</span> <span class="n">schema_type</span><span class="o">=</span><span class="s1">&#39;AVRO&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="AvroSerializerWithReferences"><a class="viewcode-back" href="../../../_autosummary/jaws_libp.references.avro.AvroSerializerWithReferences.html#jaws_libp.references.avro.AvroSerializerWithReferences">[docs]</a><span class="k">class</span> <span class="nc">AvroSerializerWithReferences</span><span class="p">(</span><span class="n">AvroSerializer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    AvroSerializer serializes objects in the Confluent Schema Registry binary</span>
<span class="sd">    format for Avro.</span>


<span class="sd">    AvroSerializer configuration properties:</span>

<span class="sd">    +---------------------------+----------+--------------------------------------------------+</span>
<span class="sd">    | Property Name             | Type     | Description                                      |</span>
<span class="sd">    +===========================+==========+==================================================+</span>
<span class="sd">    |                           |          | Registers schemas automatically if not           |</span>
<span class="sd">    | ``auto.register.schemas`` | bool     | previously associated with a particular subject. |</span>
<span class="sd">    |                           |          | Defaults to True.                                |</span>
<span class="sd">    +---------------------------+----------+--------------------------------------------------+</span>
<span class="sd">    |                           |          | Whether to use the latest subject version for    |</span>
<span class="sd">    | ``use.latest.version``    | bool     | serialization.                                   |</span>
<span class="sd">    |                           |          | WARNING: There is no check that the latest       |</span>
<span class="sd">    |                           |          | schema is backwards compatible with the object   |</span>
<span class="sd">    |                           |          | being serialized.                                |</span>
<span class="sd">    |                           |          | Defaults to False.                               |</span>
<span class="sd">    +---------------------------+----------+--------------------------------------------------+</span>
<span class="sd">    |                           |          | Callable(SerializationContext, str) -&gt; str       |</span>
<span class="sd">    |                           |          |                                                  |</span>
<span class="sd">    | ``subject.name.strategy`` | callable | Instructs the AvroSerializer on how to construct |</span>
<span class="sd">    |                           |          | Schema Registry subject names.                   |</span>
<span class="sd">    |                           |          | Defaults to topic_subject_name_strategy.         |</span>
<span class="sd">    +---------------------------+----------+--------------------------------------------------+</span>

<span class="sd">    Schemas are registered to namespaces known as Subjects which define how a</span>
<span class="sd">    schema may evolve over time. By default the subject name is formed by</span>
<span class="sd">    concatenating the topic name with the message field separated by a hyphen.</span>

<span class="sd">    i.e. {topic name}-{message field}</span>

<span class="sd">    Alternative naming strategies may be configured with the property</span>
<span class="sd">    ``subject.name.strategy``.</span>

<span class="sd">    Supported subject name strategies:</span>

<span class="sd">    +--------------------------------------+------------------------------+</span>
<span class="sd">    | Subject Name Strategy                | Output Format                |</span>
<span class="sd">    +======================================+==============================+</span>
<span class="sd">    | topic_subject_name_strategy(default) | {topic name}-{message field} |</span>
<span class="sd">    +--------------------------------------+------------------------------+</span>
<span class="sd">    | topic_record_subject_name_strategy   | {topic name}-{record name}   |</span>
<span class="sd">    +--------------------------------------+------------------------------+</span>
<span class="sd">    | record_subject_name_strategy         | {record name}                |</span>
<span class="sd">    +--------------------------------------+------------------------------+</span>

<span class="sd">    See `Subject name strategy &lt;https://docs.confluent.io/current/schema-registry/serializer-formatter.html#subject-name-strategy&gt;`_ for additional details.</span>

<span class="sd">    Note:</span>
<span class="sd">        Prior to serialization all ``Complex Types`` must first be converted to</span>
<span class="sd">        a dict instance. This may handled manually prior to calling</span>
<span class="sd">        :py:func:`SerializingProducer.produce()` or by registering a `to_dict`</span>
<span class="sd">        callable with the AvroSerializer.</span>

<span class="sd">        See ``avro_producer.py`` in the examples directory for example usage.</span>

<span class="sd">    Note:</span>
<span class="sd">       Tuple notation can be used to determine which branch of an ambiguous union to take.</span>

<span class="sd">       See `fastavro notation &lt;https://fastavro.readthedocs.io/en/latest/writer.html#using-the-tuple-notation-to-specify-which-branch-of-a-union-to-take&gt;`_</span>

<span class="sd">    Args:</span>
<span class="sd">        schema_registry_client (SchemaRegistryClient): Schema Registry client instance.</span>

<span class="sd">        schema (str or Schema): Avro `Schema Declaration. &lt;https://avro.apache.org/docs/current/spec.html#schemas&gt;`_</span>

<span class="sd">        to_dict (callable, optional): Callable(object, SerializationContext) -&gt; dict. Converts object to a dict.</span>

<span class="sd">        conf (dict): AvroSerializer configuration.</span>

<span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_hash&#39;</span><span class="p">,</span> <span class="s1">&#39;_auto_register&#39;</span><span class="p">,</span> <span class="s1">&#39;_use_latest_version&#39;</span><span class="p">,</span> <span class="s1">&#39;_known_subjects&#39;</span><span class="p">,</span> <span class="s1">&#39;_parsed_schema&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;_registry&#39;</span><span class="p">,</span> <span class="s1">&#39;_schema&#39;</span><span class="p">,</span> <span class="s1">&#39;_schema_id&#39;</span><span class="p">,</span> <span class="s1">&#39;_schema_name&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;_subject_name_func&#39;</span><span class="p">,</span> <span class="s1">&#39;_to_dict&#39;</span><span class="p">,</span> <span class="s1">&#39;_named_schemas&#39;</span><span class="p">]</span>

    <span class="c1"># default configuration</span>
    <span class="n">_default_conf</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;auto.register.schemas&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                     <span class="s1">&#39;use.latest.version&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                     <span class="s1">&#39;subject.name.strategy&#39;</span><span class="p">:</span> <span class="n">topic_subject_name_strategy</span><span class="p">}</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema_registry_client</span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">to_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">conf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">named_schemas</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema_registry_client</span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="n">Schema</span><span class="p">,</span> <span class="n">to_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">conf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">named_schemas</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="o">...</span>

<div class="viewcode-block" id="AvroSerializerWithReferences.__init__"><a class="viewcode-back" href="../../../_autosummary/jaws_libp.references.avro.AvroSerializerWithReferences.html#jaws_libp.references.avro.AvroSerializerWithReferences.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema_registry_client</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">to_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">conf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">named_schemas</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">_schema_loads</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">Schema</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You must pass either str or Schema&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_named_schemas</span> <span class="o">=</span> <span class="n">named_schemas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span> <span class="o">=</span> <span class="n">schema_registry_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schema_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Avoid calling registry if schema is known to be registered</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_known_subjects</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">to_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">to_dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;to_dict must be callable with the signature&quot;</span>
                             <span class="s2">&quot; to_dict(object, SerializationContext)-&gt;dict&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_to_dict</span> <span class="o">=</span> <span class="n">to_dict</span>

        <span class="c1"># handle configuration</span>
        <span class="n">conf_copy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_conf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">conf_copy</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_auto_register</span> <span class="o">=</span> <span class="n">conf_copy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;auto.register.schemas&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_auto_register</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;auto.register.schemas must be a boolean value&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_use_latest_version</span> <span class="o">=</span> <span class="n">conf_copy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;use.latest.version&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_use_latest_version</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;use.latest.version must be a boolean value&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_latest_version</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_register</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cannot enable both use.latest.version and auto.register.schemas&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_subject_name_func</span> <span class="o">=</span> <span class="n">conf_copy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;subject.name.strategy&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subject_name_func</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;subject.name.strategy must be callable&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conf_copy</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognized properties: </span><span class="si">{}</span><span class="s2">&quot;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">conf_copy</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>

        <span class="c1"># convert schema_str to Schema instance</span>
        <span class="n">schema_dict</span> <span class="o">=</span> <span class="n">loads</span><span class="p">(</span><span class="n">schema</span><span class="o">.</span><span class="n">schema_str</span><span class="p">)</span>
        <span class="n">parsed_schema</span> <span class="o">=</span> <span class="n">parse_schema</span><span class="p">(</span><span class="n">schema_dict</span><span class="p">,</span> <span class="n">named_schemas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_named_schemas</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parsed_schema</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># if parsed_schema is a list, we have an Avro union and there</span>
            <span class="c1"># is no valid schema name. This is fine because the only use of</span>
            <span class="c1"># schema_name is for supplying the subject name to the registry</span>
            <span class="c1"># and union types should use topic_subject_name_strategy, which</span>
            <span class="c1"># just discards the schema name anyway</span>
            <span class="n">schema_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># The Avro spec states primitives have a name equal to their type</span>
            <span class="c1"># i.e. {&quot;type&quot;: &quot;string&quot;} has a name of string.</span>
            <span class="c1"># This function does not comply.</span>
            <span class="c1"># https://github.com/fastavro/fastavro/issues/415</span>
            <span class="n">schema_name</span> <span class="o">=</span> <span class="n">parsed_schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">schema_dict</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">=</span> <span class="n">schema</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schema_name</span> <span class="o">=</span> <span class="n">schema_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parsed_schema</span> <span class="o">=</span> <span class="n">parsed_schema</span></div>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Serializes an object to the Confluent Schema Registry&#39;s Avro binary</span>
<span class="sd">        format.</span>

<span class="sd">        Args:</span>
<span class="sd">            obj (object): object instance to serializes.</span>

<span class="sd">            ctx (SerializationContext): Metadata pertaining to the serialization operation.</span>

<span class="sd">        Note:</span>
<span class="sd">            None objects are represented as Kafka Null.</span>

<span class="sd">        Raises:</span>
<span class="sd">            SerializerError: if any error occurs serializing obj</span>

<span class="sd">        Returns:</span>
<span class="sd">            bytes: Confluent Schema Registry formatted Avro bytes</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">subject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subject_name_func</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">subject</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_known_subjects</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_latest_version</span><span class="p">:</span>
                <span class="n">latest_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_schema_id</span> <span class="o">=</span> <span class="n">latest_schema</span><span class="o">.</span><span class="n">schema_id</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Check to ensure this schema has been registered under subject_name.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_register</span><span class="p">:</span>
                    <span class="c1"># The schema name will always be the same. We can&#39;t however register</span>
                    <span class="c1"># a schema without a subject so we set the schema_id here to handle</span>
                    <span class="c1"># the initial registration.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_schema_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">register_schema</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span>
                                                                     <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">registered_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">lookup_schema</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span>
                                                                     <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_schema_id</span> <span class="o">=</span> <span class="n">registered_schema</span><span class="o">.</span><span class="n">schema_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_known_subjects</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_dict</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">obj</span>

        <span class="k">with</span> <span class="n">_ContextStringIO</span><span class="p">()</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
            <span class="c1"># Write the magic byte and schema ID in network byte order (big endian)</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;bI&#39;</span><span class="p">,</span> <span class="n">_MAGIC_BYTE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema_id</span><span class="p">))</span>
            <span class="c1"># write the record to the rest of the buffer</span>
            <span class="n">schemaless_writer</span><span class="p">(</span><span class="n">fo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsed_schema</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">fo</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span></div>


<div class="viewcode-block" id="AvroDeserializerWithReferences"><a class="viewcode-back" href="../../../_autosummary/jaws_libp.references.avro.AvroDeserializerWithReferences.html#jaws_libp.references.avro.AvroDeserializerWithReferences">[docs]</a><span class="k">class</span> <span class="nc">AvroDeserializerWithReferences</span><span class="p">(</span><span class="n">AvroDeserializer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    AvroDeserializer decodes bytes written in the Schema Registry</span>
<span class="sd">    Avro format to an object.</span>

<span class="sd">    Note:</span>
<span class="sd">        ``Complex Types`` are returned as dicts. If a more specific instance</span>
<span class="sd">        type is desired a callable, ``from_dict``, may be registered with</span>
<span class="sd">        the AvroDeserializer which converts a dict to the desired type.</span>

<span class="sd">        See ``avro_consumer.py`` in the examples directory in the examples</span>
<span class="sd">        directory for example usage.</span>

<span class="sd">    Args:</span>
<span class="sd">        schema_registry_client (SchemaRegistryClient): Confluent Schema Registry</span>
<span class="sd">            client instance.</span>

<span class="sd">        schema (str, Schema, optional): Avro reader schema declaration.</span>
<span class="sd">            If not provided, writer schema is used for deserialization.</span>

<span class="sd">        from_dict (callable, optional): Callable(dict, SerializationContext) -&gt; object.</span>
<span class="sd">            Converts dict to an instance of some object.</span>

<span class="sd">        return_record_name (bool): If True, when reading a union of records, the result will</span>
<span class="sd">                                   be a tuple where the first value is the name of the record and the second value is</span>
<span class="sd">                                   the record itself.  Defaults to False.</span>

<span class="sd">    See Also:</span>
<span class="sd">        `Apache Avro Schema Declaration &lt;https://avro.apache.org/docs/current/spec.html#schemas&gt;`_</span>

<span class="sd">        `Apache Avro Schema Resolution &lt;https://avro.apache.org/docs/1.8.2/spec.html#Schema+Resolution&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_reader_schema&#39;</span><span class="p">,</span> <span class="s1">&#39;_registry&#39;</span><span class="p">,</span> <span class="s1">&#39;_from_dict&#39;</span><span class="p">,</span> <span class="s1">&#39;_writer_schemas&#39;</span><span class="p">,</span> <span class="s1">&#39;_return_record_name&#39;</span><span class="p">,</span> <span class="s1">&#39;_schema&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;_named_schemas&#39;</span><span class="p">]</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema_registry_client</span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">from_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_record_name</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">named_schemas</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema_registry_client</span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="n">Schema</span><span class="p">,</span> <span class="n">from_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_record_name</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">named_schemas</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="o">...</span>

<div class="viewcode-block" id="AvroDeserializerWithReferences.__init__"><a class="viewcode-back" href="../../../_autosummary/jaws_libp.references.avro.AvroDeserializerWithReferences.html#jaws_libp.references.avro.AvroDeserializerWithReferences.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema_registry_client</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_record_name</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">named_schemas</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">_schema_loads</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">Schema</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You must pass either str, Schema, or None&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_named_schemas</span> <span class="o">=</span> <span class="n">named_schemas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">=</span> <span class="n">schema</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span> <span class="o">=</span> <span class="n">schema_registry_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_writer_schemas</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_reader_schema</span> <span class="o">=</span> <span class="n">parse_schema</span><span class="p">(</span><span class="n">loads</span><span class="p">(</span><span class="n">schema</span><span class="o">.</span><span class="n">schema_str</span><span class="p">),</span>
                                           <span class="n">named_schemas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_named_schemas</span><span class="p">)</span> <span class="k">if</span> <span class="n">schema</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">from_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">from_dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;from_dict must be callable with the signature&quot;</span>
                             <span class="s2">&quot; from_dict(SerializationContext, dict) -&gt; object&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_from_dict</span> <span class="o">=</span> <span class="n">from_dict</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_return_record_name</span> <span class="o">=</span> <span class="n">return_record_name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_return_record_name</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;return_record_name must be a boolean value&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decodes a Confluent Schema Registry formatted Avro bytes to an object.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            value (bytes): bytes</span>

<span class="sd">            ctx (SerializationContext): Metadata pertaining to the serialization</span>
<span class="sd">                operation.</span>

<span class="sd">        Raises:</span>
<span class="sd">            SerializerError: if an error occurs ready data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            object: object if ``from_dict`` is set, otherwise dict. If no value is supplied None is returned.</span>

<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SerializationError</span><span class="p">(</span><span class="s2">&quot;Message too small. This message was not&quot;</span>
                                     <span class="s2">&quot; produced with a Confluent&quot;</span>
                                     <span class="s2">&quot; Schema Registry serializer&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">_ContextStringIO</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">as</span> <span class="n">payload</span><span class="p">:</span>
            <span class="n">magic</span><span class="p">,</span> <span class="n">schema_id</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;bI&#39;</span><span class="p">,</span> <span class="n">payload</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">magic</span> <span class="o">!=</span> <span class="n">_MAGIC_BYTE</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SerializationError</span><span class="p">(</span><span class="s2">&quot;Unknown magic byte. This message was&quot;</span>
                                         <span class="s2">&quot; not produced with a Confluent&quot;</span>
                                         <span class="s2">&quot; Schema Registry serializer&quot;</span><span class="p">)</span>

            <span class="n">writer_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_writer_schemas</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">schema_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">writer_schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">registered_schema</span><span class="p">:</span> <span class="n">Schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">get_schema</span><span class="p">(</span><span class="n">schema_id</span><span class="p">)</span>
                <span class="n">prepared_schema</span><span class="p">:</span> <span class="n">Schema</span> <span class="o">=</span> <span class="n">_schema_loads</span><span class="p">(</span><span class="n">registered_schema</span><span class="o">.</span><span class="n">schema_str</span><span class="p">)</span>
                <span class="n">writer_schema</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">parse_schema</span><span class="p">(</span><span class="n">loads</span><span class="p">(</span>
                    <span class="n">prepared_schema</span><span class="o">.</span><span class="n">schema_str</span><span class="p">),</span> <span class="n">named_schemas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_named_schemas</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_writer_schemas</span><span class="p">[</span><span class="n">schema_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">writer_schema</span>

            <span class="n">obj_dict</span> <span class="o">=</span> <span class="n">schemaless_reader</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span>
                                         <span class="n">writer_schema</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">_reader_schema</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">_return_record_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_dict</span><span class="p">(</span><span class="n">obj_dict</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">obj_dict</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Jefferson Lab.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>